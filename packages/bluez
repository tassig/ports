package_name=bluez
package_version=5.44
tarball_suffix=xz
build_dependencies="libical dbus readline glib"
iscustombuild=1
haspostinstall=1

##########################
#
# bluez
#
# bluez is a Bluetooth stack for linux
# 
##########################


# TODO: fix obex building

# custom build because configure will not link with readline and ncurses. And currently, need to disable obex
custombuild(){
	rm -rf builddir
	mkdir -p builddir   # do everything in builddir for tidiness
	cd builddir
	wget -O archive $url
	tar xvf archive
	rm archive
	cd *   # cd into the package directory
 
	LDFLAGS="-L$installdirectory/readline/lib -L$installdirectory/ncurses/lib -lncurses -lreadline \
			-Wl,-rpath,$installdirectory/ncurses/lib \
			-Wl,-rpath,$installdirectory/readline/lib" \
		CFLAGS="-I$installdirectory/readline/include" \
		ICAL_CFLAGS="-I$installdirectory/libical/include" \
		ICAL_LIBS="-L$installdirectory/libical/lib -Wl,-rpath,$installdirectory/libical/lib" \
		DBUS_CFLAGS="-I$installdirectory/dbus/include/dbus-1.0 \
			-I$installdirectory/dbus/lib/dbus-1.0/include" \
		DBUS_LIBS="-L$installdirectory/dbus/lib -Wl,-rpath,$installdirectory/dbus/lib -ldbus-1" \
		./configure --prefix=$installdirectory/$package_fullname \
			--disable-udev \
			--disable-systemd \
			--disable-obex \
			--disable-tools \
			--with-dbusconfdir=$installdirectory/$package_fullname/etc/ \
			--with-dbussystembusdir=/var/run/$package_name \
			--localstatedir=/var/
	ncpu=`cat /proc/cpuinfo | grep processor | wc -l`
	make -j$ncpu
	if test -z $no_check   # run the make check, unless $no_check is set for this package definition
	then make -j$ncpu check || make -j$ncpu test
	fi
	make install
	ln -sv $installdirectory/$package_fullname $installdirectory/$package_name
	ln -sv $installdirectory/$package_name/bin/* /bin/ || true   # don't crash if the links are already there
	if [ -d "$installdirectory/$package_name/lib/pkgconfig" ]; then
		ln -svf $installdirectory/$package_name/lib/pkgconfig/* \
		$installdirectory/pkgconf/lib/pkgconfig/   # install pkg-config files
	fi
	cd ../..
	rm -r builddir
}

# install wrappers and dbus config
postinstall()
{
	mkdir -p /var/run/bluez
	# make wrappers
	echo "#!/bin/sh
set -e
# if there is pid file
[ -e /var/run/bluez/pid ] && {
    # kill -0 will only check if dbus is running
    kill -0 `cat /var/run/bluez/pid` >/dev/null 2>/dev/null || {
        # remove all running stuff
        rm -f /var/run/bluez/*
    }
}
DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/bluez/system_bus_socket $installdirectory/dbus/bin/dbus-daemon --config-file=$installdirectory/bluez/etc/dbus-1/system.d/bluetooth.conf
DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/bluez/system_bus_socket $installdirectory/bluez/libexec/bluetooth/bluetoothd &
" > $installdirectory/bluez/bin/bluetoothd
chmod a+x $installdirectory/bluez/bin/bluetoothd

mv $installdirectory/bluez/bin/bluetoothctl $installdirectory/bluez/bin/bluetoothctl-real
echo "#!/bin/sh
DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/bluez/system_bus_socket $installdirectory/bluez/bin/bluetoothctl-real
" > $installdirectory/bluez/bin/bluetoothctl
chmod a+x $installdirectory/bluez/bin/bluetoothctl

echo '<!-- This configuration file specifies the required security policies
     for Bluetooth core daemon to work. -->

<!DOCTYPE busconfig PUBLIC "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
<busconfig>

  <!-- ../system.conf have denied everything, so we just punch some holes -->

<policy context="default">
    <!-- All users can connect to system bus -->
    <allow user="*"/>

    <!-- Holes must be punched in service configuration files for
         name ownership and sending method calls -->
    <deny own="*"/>
    <deny send_type="method_call"/>

    <!-- Signals and reply messages (method returns, errors) are allowed
         by default -->
    <allow send_type="signal"/>
    <allow send_requested_reply="true" send_type="method_return"/>
    <allow send_requested_reply="true" send_type="error"/>

    <!-- All messages may be received by default -->
    <allow receive_type="method_call"/>
    <allow receive_type="method_return"/>
    <allow receive_type="error"/>
    <allow receive_type="signal"/>

    <!-- Allow anyone to talk to the message bus -->
    <allow send_destination="org.freedesktop.DBus"/>
    <!-- But disallow some specific bus services -->
    <deny send_destination="org.freedesktop.DBus"
          send_interface="org.freedesktop.DBus"
          send_member="UpdateActivationEnvironment"/>
  </policy>

  <policy user="root">
    <allow own="org.bluez"/>
    <allow send_destination="org.bluez"/>
    <allow send_interface="org.bluez.Agent1"/>
    <allow send_interface="org.bluez.MediaEndpoint1"/>
    <allow send_interface="org.bluez.MediaPlayer1"/>
    <allow send_interface="org.bluez.ThermometerWatcher1"/>
    <allow send_interface="org.bluez.AlertAgent1"/>
    <allow send_interface="org.bluez.Profile1"/>
    <allow send_interface="org.bluez.HeartRateWatcher1"/>
    <allow send_interface="org.bluez.CyclingSpeedWatcher1"/>
    <allow send_interface="org.bluez.GattCharacteristic1"/>
    <allow send_interface="org.bluez.GattDescriptor1"/>
    <allow send_interface="org.freedesktop.DBus.ObjectManager"/>
    <allow send_interface="org.freedesktop.DBus.Properties"/>
  </policy>

  <policy at_console="true">
    <allow send_destination="org.bluez"/>
  </policy>

  <!-- allow users of lp group (printing subsystem) to 
       communicate with bluetoothd -->
<!--  <policy group="lp">
    <allow send_destination="org.bluez"/>
  </policy> -->

  <policy context="default">
    <deny send_destination="org.bluez"/>
  </policy>

  <fork/>

  <listen>unix:path=/var/run/bluez/system_bus_socket</listen> 
  <pidfile>/var/run/bluez/pid</pidfile>
  <!-- Our well-known bus type, do not change this -->
  <type>system</type>

  <!-- Run as special user -->
<!--  <user>messagebus</user> -->

</busconfig>' > $installdirectory/bluez/etc/dbus-1/system.d/bluetooth.conf

}
