
# the list of dependencies is taken from http://www.x.org/wiki/Building_the_X_Window_System/
# however more dependencies are actually needed, for example python, and some dependencies can be replaced by other software

build_dependencies="git autoconf automake libpng mtdev pkgconf python2 gettext flex bison freetype fontconfig python-mako eudev llvm python3 wget libtool intltool"
iscustombuild=1


##########################
#
# X.org
#
# NOTE: different way to build than other software
#
##########################

custombuild(){
	# we're building X.org release 7.7
	
	# get util/modular (where the build.sh file is located)
	pwd="`pwd`"
	mkdir $HOME/src
	cd $HOME/src
	# normally, we should move to the git commit corresponding to the 7.7 release, see: https://cgit.freedesktop.org/xorg/util/modular/log/
	# but the version of build.sh at that time is a bit buggy, so we use the newer version
	git clone git://anongit.freedesktop.org/git/xorg/util/modular util/modular
	export PREFIX=/opt/xorg #$HOME/build
	mkdir -p $PREFIX
	
	
	# get the tarballs of the 7.7 release as a tree
	wget -r --no-parent -A.tar.gz http://mirrors.tassig.com/xorg/src/
	mv mirrors.tassig.com/xorg/src/* ./
	
	# for some dependencies, X.org does not distribute the tarballs, so we get the code ourselves
	# get a stable release of pixman, MESA - projects external to X.org
	wget http://mirrors.tassig.com/pixman/pixman-0.34.0.tar.gz
	mkdir -p mesa
	cd mesa
	#wget http://mirrors.tassig.com/mesa/MesaLib-10.4.7.tar.gz  # a version released approximately at the same time as X.org 7.7
	git clone git://anongit.freedesktop.org/git/mesa/drm   # TODO: need to choose a particular commit, not take the latest version
	git clone git://anongit.freedesktop.org/git/mesa/mesa   # TODO: need to choose a particular commit, not take the latest version
	cd ..
	cd proto
	git clone git://anongit.freedesktop.org/git/xorg/proto/dri3proto   # mesa needs it TODO: double-check
	git clone git://anongit.freedesktop.org/git/xorg/proto/presentproto   # mesa needs it TODO: double-check
	cd ..
	cd lib
	git clone git://anongit.freedesktop.org/git/xorg/lib/libxshmfence   # mesa needs it
	cd ..
	cd app
	git clone git://anongit.freedesktop.org/git/xorg/app/xinit
	git clone git://anongit.freedesktop.org/git/xorg/app/twm
	git clone git://anongit.freedesktop.org/git/xorg/app/xclock
	cd ..
	cd util
	git clone git://anongit.freedesktop.org/git/xorg/util/macros   # wanted by build.sh and the latest version of libxcb
	# TODO: explain why these ones below are needed
	git clone git://anongit.freedesktop.org/git/xorg/util/cf
	git clone git://anongit.freedesktop.org/git/xorg/util/imake
	git clone git://anongit.freedesktop.org/git/xorg/util/gccmakedep
	git clone git://anongit.freedesktop.org/git/xorg/util/lndir
	cd ..
	cp -v everything/xkeyboard-config-2.6.tar.gz .
	
	
	# replacements of the 7.7 packages with newer versions
	cd xcb
	rm libxcb-1.8.1.tar.gz
	rm xcb-proto-1.7.1.tar.gz
	git clone git://anongit.freedesktop.org/git/xcb/libxcb
	git clone git://anongit.freedesktop.org/git/xcb/proto
	cd ..
	

	# unpack the parts to be patched
	cd app
	tar xvf sessreg-1.0.7.tar.gz
	cd ../lib
	tar xvf libpciaccess-0.13.1.tar.gz
	cd ..
	tar xvf xserver/xorg-server-1.12.2.tar.gz
	cd font
	for f in *.tar.gz; do
		tar xvf $f
	done
	cd ..
	
	
	#echo all: > $HOME/build/Makefile.dummy
	#PREFIX=/opt/xorg ./util/modular/build.sh $HOME/build --cmd "make -f$HOME/build/Makefile.dummy"
	
	# apply patches (for musl compatibility)
	for p in "$pwd"/packages/xorg-*.patch; do
		patch -p1 < $p
	done
	
	# patch for fc-cache hanging on some fonts (TODO: is that even a correct explanation?)
	for f in font/*/; do
		sed -i 's/@RUN_FCCACHE@/#@RUN_FCCACHE@/' $f/Makefile.am
		sed -i 's/@RUN_FCCACHE@/#@RUN_FCCACHE@/' $f/Makefile.in
	done

	export CFLAGS="-D_GNU_SOURCE -I/opt/zlib/include -I/opt/eudev/include -I/opt/mtdev/include"   # TODO: comments needed - D_GNU_SOURCE a bit funny in our context
	export LDFLAGS="$LDFLAGS -Wl,-rpath=$PREFIX/lib -Wl,-rpath=/opt/freetype/lib -Wl,-rpath=/opt/zlib/lib"
	export LDFLAGS="$LDFLAGS -Wl,-rpath=/opt/fontconfig/lib -Wl,-rpath=/opt/expat/lib -Wl,-rpath=/opt/libpng/lib"
	export LDFLAGS="$LDFLAGS -L/opt/eudev/lib -L/opt/mtdev/lib -L/opt/zlib/lib"

	#export PREFIX=/opt/xorg/; ./util/modular/build.sh --clone $HOME/build --check --autoresume resumefile
	./util/modular/build.sh --autoresume resumefile
	
	
	cat <<EOF >$PREFIX/share/X11/xorg.conf.d/20-modules.conf
Section "Module"
  Load "int10"
  Load "fb"
  Load "shadow"
  Load "vbe"
  Load "vesa"
EndSection
EOF
}
