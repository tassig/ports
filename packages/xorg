
# the list of dependencies is taken from http://www.x.org/wiki/Building_the_X_Window_System/
# however more dependencies are actually needed, for example python, and some dependencies can be replaced by other software

build_dependencies="autoconf automake libtool pkgconf python2 gettext flex bison freetype fontconfig python-mako eudev llvm"
iscustombuild=1


##########################
#
# X.org
#
# NOTE: slightly different way to build than other software
#
# Issues to fix manually:
# * mesa/drm/libkms/kms-symbol-check (and intel, nouveau, etc.) scripts are /bin/bash, change to sh
# * mesa/drm/tests/nouveau/threaded.c : non posix signature for ioctl()
# * mesa/mesa: the mesa built failed with the musl-gcc wrapper over gcc-glibc, so we use the gcc-musl as in llvm, and the build is manual
# * mesa/mesa: another error involving bash, replace /bin/sh
# * mesa/mesa/src/glx: Makefile:785: recipe for target 'libGL.la' failed
#
##########################

custombuild(){
	pwd="`pwd`"
	mkdir $HOME/src
	cd $HOME/src
	git clone git://anongit.freedesktop.org/git/xorg/util/modular util/modular
	mkdir $HOME/build
	cd $HOME/src
	export PREFIX=/opt/xorg/; ./util/modular/build.sh --clone $HOME/build --check --cmd "git checkout HEAD"
	for p in "$pwd"/packages/xorg-*.patch; do
		patch -p1 < $p
	done
	
	
	# hack for libfontenc that assumes zlib.h is a system header, which is not true TODO: fix libfontenc
	ln -sv /opt/zlib/include/zlib.h /opt/native-compiler-musl/x86_64-linux-musl/include/
	ln -sv /opt/zlib/lib/libz.so* /opt/native-compiler-musl/x86_64-linux-musl/lib/
	

	#export PREFIX=/opt/xorg/; ./util/modular/build.sh --clone $HOME/build --check
	#export PREFIX=/opt/xorg/; ./util/modular/build.sh --clone $HOME/build --check --autoresume resumefile
	export PREFIX=/opt/xorg/; ./util/modular/build.sh --clone $HOME/build --autoresume resumefile
	
	
	# previous hack cleanup
	rm /opt/native-compiler-musl/x86_64-linux-musl/include/zlib.h
	rm /opt/native-compiler-musl/x86_64-linux-musl/lib/libz.so*
}
