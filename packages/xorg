
# the list of dependencies is taken from http://www.x.org/wiki/Building_the_X_Window_System/
# however more dependencies are actually needed, for example python, and some dependencies can be replaced by other software

package_name=xorg
package_version=X11R7.7
build_dependencies="git autoconf automake libtool mtdev pkgconf python2 gettext flex bison freetype fontconfig python-mako eudev llvm python3 wget libpng intltool"
iscustombuild=1


##########################
#
# X.org
#
# NOTE: different way to build than other software
#
##########################

custombuild(){
	# we're building X.org release 7.7
	
	# get util/modular (where the build.sh file is located)
	pwd="`pwd`"
	mkdir $HOME/src
	cd $HOME/src
	export PREFIX=/opt/$package_name-$package_version
	mkdir -p $PREFIX
	
	# get the tarballs of the 7.7 release as a tree
	wget -r --no-parent -A.tar.gz http://mirrors.tassig.com/xorg/src/
	mv mirrors.tassig.com/xorg/src/* ./
	
	# get the build.sh script
	# normally, we should move to the git commit corresponding to the 7.7 release, see: https://cgit.freedesktop.org/xorg/util/modular/log/
	# but the version of build.sh at that time is a bit buggy, so we use the newer version
	git clone git://anongit.freedesktop.org/git/xorg/util/modular util/modular
	
	# for some dependencies, X.org does not distribute the tarballs, so we get the code ourselves
	# get a stable release of pixman, MESA - projects external to X.org
	wget http://mirrors.tassig.com/pixman/pixman-0.34.0.tar.gz
	mkdir -p mesa
	cd mesa
	#wget http://mirrors.tassig.com/mesa/MesaLib-10.4.7.tar.gz  # a version released approximately at the same time as X.org 7.7
	git clone git://anongit.freedesktop.org/git/mesa/drm   # TODO: need to choose a particular commit, not take the latest version
	git clone git://anongit.freedesktop.org/git/mesa/mesa   # TODO: need to choose a particular commit, not take the latest version
	cd ..
	cd proto
	git clone git://anongit.freedesktop.org/git/xorg/proto/dri3proto   # mesa needs it TODO: double-check
	git clone git://anongit.freedesktop.org/git/xorg/proto/presentproto   # mesa needs it TODO: double-check
	git clone git://anongit.freedesktop.org/git/xorg/proto/glproto   # xserver needs it
	git clone git://anongit.freedesktop.org/git/xorg/proto/inputproto   # xserver needs it
	git clone git://anongit.freedesktop.org/git/xorg/proto/x11proto   # xserver needs it
	git clone git://anongit.freedesktop.org/git/xorg/proto/randrproto   # xserver needs it
	git clone git://anongit.freedesktop.org/git/xorg/proto/xextproto   # xserver needs it
	git clone git://anongit.freedesktop.org/git/xorg/proto/fontsproto   # xserver needs it
	git clone git://anongit.freedesktop.org/git/xorg/proto/videoproto   # video-v4l needs it
	cd ..
	cd lib
	git clone git://anongit.freedesktop.org/git/xorg/lib/libxshmfence   # mesa needs it
	git clone git://anongit.freedesktop.org/git/xorg/lib/libxtrans   # xserver needs it
	cd ..
	cd app
	git clone git://anongit.freedesktop.org/git/xorg/app/xinit
	git clone git://anongit.freedesktop.org/git/xorg/app/twm
	git clone git://anongit.freedesktop.org/git/xorg/app/xclock
	cd ..
	cd util
	rm util-macros-1.17.tar.gz
	git clone git://anongit.freedesktop.org/git/xorg/util/macros   # wanted by build.sh and the latest version of libxcb
	# TODO: explain why these ones below are needed
	git clone git://anongit.freedesktop.org/git/xorg/util/cf
	git clone git://anongit.freedesktop.org/git/xorg/util/imake
	git clone git://anongit.freedesktop.org/git/xorg/util/gccmakedep
	git clone git://anongit.freedesktop.org/git/xorg/util/lndir
	cd ..
	cp -v everything/xkeyboard-config-2.6.tar.gz .

	
	# replacements of the 7.7 packages with newer versions TODO: get a specific commit corresponding to a release, not the git HEAD (not stable enough)
	cd xcb
	rm libxcb-1.8.1.tar.gz
	rm xcb-proto-1.7.1.tar.gz
	git clone git://anongit.freedesktop.org/git/xcb/libxcb
	git clone git://anongit.freedesktop.org/git/xcb/proto
	cd ..
	rm -r xserver # remove the xserver tarball, to make sure the build system is not using it
	git clone git://anongit.freedesktop.org/git/xorg/xserver
	git clone git://anongit.freedesktop.org/git/libevdev
	cd driver
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-input-synaptics
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-v4l
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-intel
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-ast
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-cirrus
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-dummy
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-fbdev
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-glint
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-i128
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-mach64
	#TODO: past this point I've just added all video drivers, some of them might work without that
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-mga
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-newport
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-nv
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-openchrome
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-geode
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-glide
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-r128
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-savage
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-siliconmotion
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-sis
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-suncg6
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-tdfx
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-tga
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-trident
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-vesa
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-vmware
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-voodoo
	git clone git://anongit.freedesktop.org/git/xorg/driver/xf86-video-wsfb

	rm -r xf86-video-sunffb*
	rm -r xf86-video-ark*
	rm -r xf86-video-ati*
	rm -r xf86-video-neomagic*
	cd ..
	

	# unpack the parts to be patched
	cd app
	tar xvf sessreg-1.0.7.tar.gz
	cd ../lib
	tar xvf libpciaccess-0.13.1.tar.gz
	tar xvf libXfont-1.4.5.tar.gz
	cd ..
	#tar xvf xserver/xorg-server-1.12.2.tar.gz TODO: now the patch won't work cause we're getting xserver from git
	cd font
	for f in *.tar.gz; do
		tar xvf $f
	done
	cd ..
	
	# apply patches (for musl compatibility)
	for p in "$pwd"/packages/xorg-*.patch; do
		patch -p1 < $p
	done
	
	# patch for fc-cache hanging on some fonts (TODO: is that even a correct explanation?)
	for f in font/*/; do
		sed -i 's/@RUN_FCCACHE@/#@RUN_FCCACHE@/' $f/Makefile.am
		sed -i 's/@RUN_FCCACHE@/#@RUN_FCCACHE@/' $f/Makefile.in
	done

	
	# set CFLAGS and LDFLAGS
	export CFLAGS="-D_GNU_SOURCE -I/opt/zlib/include -I/opt/eudev/include -I/opt/mtdev/include"   # TODO: comments needed - D_GNU_SOURCE a bit funny in our context
	export LDFLAGS="$LDFLAGS -Wl,-rpath=$PREFIX/lib -Wl,-rpath=/opt/freetype/lib -Wl,-rpath=/opt/zlib/lib"
	export LDFLAGS="$LDFLAGS -Wl,-rpath=/opt/fontconfig/lib -Wl,-rpath=/opt/expat/lib -Wl,-rpath=/opt/libpng/lib"
	export LDFLAGS="$LDFLAGS -L/opt/eudev/lib -L/opt/mtdev/lib -L/opt/zlib/lib"

	
	# running the main build and installation script
	./util/modular/build.sh --autoresume resumefile   # --check
	
	
	cat <<EOF >$PREFIX/share/X11/xorg.conf.d/20-modules.conf
Section "Module"
  Load "int10"
  Load "fb"
  Load "shadow"
  Load "vbe"
  Load "vesa"
EndSection
EOF
}
