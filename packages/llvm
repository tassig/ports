package_name=llvm
package_version=3.8.0
tarball_suffix=xz
url=http://mirrors.tassig.com/llvm/llvm-3.8.0.src.tar.xz
build_dependencies="cmake python"
iscustombuild=1

custombuild(){
	set -e
        package_fullname=$package_name-$package_version
        package_tarball_name=$package_fullname.src.tar.$tarball_suffix
        wget $url
        tar xvf $package_tarball_name
        rm $package_tarball_name
	cd $package_fullname.src
	for p in ../packages/llvm-*.patch; do
		patch -p1 < $p
	done
	cd ..
	mkdir llvm-build
	cd llvm-build
	
	# ./configure is deprecated AND failes to compile after successfully configuring
	#../$package_fullname.src/configure --prefix=/opt/$package_fullname/
	cmake -DCMAKE_INSTALL_PREFIX=/opt/$package_fullname/ -DBUILD_SHARED_LIBS=ON ../$package_fullname.src/   # shared libs needed by mesa

	make -j4   # difficult to do more than that, the build chokes, memory usage too high
	make install
	ln -sv /opt/$package_fullname /opt/$package_name
	ln -sv /opt/$package_name/bin/* /bin/ || true
	cd ..
	set +e
}

