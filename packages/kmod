package_name=kmod
package_version=22
tarball_suffix=xz
build_dependencies="xz"
iscustombuild=1
no_check=1 # there is no test suite

custombuild() {
	rm -rf builddir
	mkdir -p builddir   # do everything in builddir for tidiness
	cd builddir
	wget -O archive $url
	tar xvf archive
	rm archive
	cd *   # cd into the package directory

	# real custom stuff starts here
	# don't modify it even if it looks sketchy: the kmod configure script is
	# hopelessly broken and those are the workarounds that work, found
	# via trial and error; changing something WILL break the build.

	prefix=$installdirectory/$package_fullname
	KMOD_CONFIGURE_OPTIONS="--with-gnu-ld --disable-gtk-doc-html --with-xz --disable-manpages --with-bashcompletiondir=$prefix/bash-completions"
	KMOD_CONFLDFLAGS="-s -static"
	KMOD_MAKELDFLAGS="-s -all-static -L$installdirectory/xz/lib"

	LDFLAGS=$KMOD_CONFLDFLAGS \
	liblzma_CFLAGS="-I $installdirectory/xz/include" \
	liblzma_LIBS="-llzma" \
	./configure --prefix=$prefix $KMOD_CONFIGURE_OPTIONS
	make CFLAGS="-I $installdirectory/xz/include" LDFLAGS="$KMOD_MAKELDFLAGS"
	make install

	ln -sv $installdirectory/$package_fullname $installdirectory/$package_name
	ln -sv $installdirectory/$package_name/bin/* /bin/ || true   # don't crash if the links are already there
	if [ -d "$installdirectory/$package_name/lib/pkgconfig" ]; then
		ln -svf $installdirectory/$package_name/lib/pkgconfig/* \
		$installdirectory/pkgconf/lib/pkgconfig/   # install pkg-config files
	fi
	cd ../..
	rm -r builddir
}
