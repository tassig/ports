package_name=gcc
package_version=6.1.0
build_dependencies="make linux-kernel-headers"
iscustombuild=1

##########################
#
# install GCC native compiler
# C and C++ support
#
#
##########################


custombuild(){
	ARCH=`uname -m`
	packagename=$package_name-$package_version
	target_triple=$ARCH-longhorn-linux-musl
	
	
	# do binutils
	
	wget http://mirrors.tassig.com/binutils/binutils-2.26.tar.bz2
	tar xvf binutils-2.26.tar.bz2
	mkdir objdir
	cd objdir                  
	../binutils-2.26/configure --prefix=/opt/$packagename \
	                           --with-lib-path=/lib \
	                           --build=$target_triple \
	                           --disable-werror \
	                           --disable-nls
	make -j
	#make check
	make install
	cd ..
	rm -r objdir
	
	
	
	# do musl libc
	
	wget http://mirrors.tassig.com/musl/musl-1.1.14.tar.gz
	tar xvf musl-1.1.14.tar.gz
	cd musl-1.1.14
	./configure --prefix=/opt/$packagename/$target_triple
	make -j
	make install
	cp /opt/$packagename/$target_triple/lib/libc.so /lib/ld-musl-$ARCH.so.1
	echo "/opt/$packagename/$target_triple/lib/" > /etc/ld-musl-$ARCH.path
	echo "/opt/$packagename/lib64" >> /etc/ld-musl-$ARCH.path
	echo "/lib" >> /etc/ld-musl-$ARCH.path
	cd ..
	rm -r musl*

	
	
	# do gcc
	
	wget http://mirrors.tassig.com/gcc/gcc-6.1.0.tar.bz2
	tar xvf gcc-6.1.0.tar.bz2
	cd gcc-6.1.0/
	contrib/download_prerequisites
	
	echo "echo '$target_triple'" > config.guess
	cp -f config.guess mpc/config.guess
	cp -f config.guess isl/config.guess
	cp -f config.guess gmp/config.guess
	cp -f config.guess mpfr/config.guess
	cp -f config.guess config.sub
	cp -f config.sub mpc/config.sub
	cp -f config.sub isl/config.sub
	cp -f config.sub gmp/config.sub
	cp -f config.sub mpfr/config.sub
	
	NOTE: can also add the unofficial gcc patches for advanced features
	mkdir patches-gcc-6.1.0
	cd patches-gcc-6.1.0
	wget http://port70.net/~nsz/musl/gcc-6.1.0/0001-cilkrts.patch
	wget http://port70.net/~nsz/musl/gcc-6.1.0/0002-posix_memalign.patch
	wget http://port70.net/~nsz/musl/gcc-6.1.0/0003-libgcc_s.patch
	wget http://port70.net/~nsz/musl/gcc-6.1.0/0004-linux_libc_has_function.patch
	wget http://port70.net/~nsz/musl/gcc-6.1.0/0005-nopie.patch
	wget http://port70.net/~nsz/musl/gcc-6.1.0/0006-ssp_nonshared.patch
	wget http://port70.net/~nsz/musl/gcc-6.1.0/targetlib-test-fix.diff
	cd ../
	for file in patches-gcc-6.1.0/*;do patch -p1 -i $file;done
	cd ../

	cd ..
	mkdir gccobjdir
	cd gccobjdir
	../gcc-6.1.0/configure --prefix=/opt/$packagename \
	                       --enable-languages=c,c++ \
	                       --with-native-system-header-dir=/opt/$packagename/$target_triple/include \
	                       --disable-multilib \
	                       --disable-nls \
	                       --disable-libsanitizer \
	                       --disable-libcilkrts
	ln -sv /opt/$packagename/$target_triple/lib/*.o /lib/   # hack to pass the bootstrap stage, some configure scripts probably incorrect TODO: could be patched
	make --debug -j4
	rm /lib/*.o   # previous hack clean up
	#make -k check -j
	make install
	cd ..
	rm -r gccobjdir
	
	
	# final links
	
	ln -svf /opt/$packagename/bin/* /bin/
	ln -svf /opt/linux-kernel-headers/include/* /opt/$packagename/$target_triple/include/   # linux headers into system headers location
	
	
	
	# do musl libc again, this time it will use the new compiler
	
	wget http://mirrors.tassig.com/musl/musl-1.1.14.tar.gz
	tar xvf musl-1.1.14.tar.gz
	cd musl-1.1.14
	./configure --prefix=/opt/$packagename/$target_triple
	make -j
	make install
	cp /opt/$packagename/$target_triple/lib/libc.so /lib/ld-musl-$ARCH.so.1
	cd ..
	rm -r musl*
	
	
}
