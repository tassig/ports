#!/bin/sh
set -e

COMMAND="$1"

usage()
{
	echo "$0 start|stop"
}

start()
{
	# if there is pid file
	[ -e /var/run/bluez/pid ] && {
	    # kill -0 will only check if dbus is running. if it is, then exit
	    kill -0 `cat /var/run/bluez/pid` >/dev/null 2>/dev/null && exit 0 || {
	        # remove all running stuff
	        rm -f /var/run/bluez/*
	    }
	}
	DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/bluez/system_bus_socket /opt/dbus/bin/dbus-daemon --config-file=/opt/bluez/etc/dbus-1/system.d/bluetooth.conf
	DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/bluez/system_bus_socket /opt/bluez/libexec/bluetooth/bluetoothd &
}

stop()
{
	[ -e /var/run/bluez/pid ] || exit 0
	# this will kill dbus, which triggers bluetoothd to be dead too
	kill `cat /var/run/bluez/pid`
}

case "$COMMAND" in
	start)
		start
		;;
	stop)
		stop
		;;
	*)
		usage
		;;
esac
